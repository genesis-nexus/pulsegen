// Prisma Schema for PulseGen Survey Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  VIEWER
}

enum SurveyStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
}

enum QuestionType {
  MULTIPLE_CHOICE
  CHECKBOXES
  DROPDOWN
  RATING_SCALE
  MATRIX
  RANKING
  SHORT_TEXT
  LONG_TEXT
  EMAIL
  NUMBER
  DATE
  TIME
  FILE_UPLOAD
  SLIDER
  YES_NO
  NPS
  LIKERT_SCALE
}

enum LogicType {
  SKIP_LOGIC
  BRANCHING
  PIPING
  DISPLAY_LOGIC
}

enum ExportFormat {
  CSV
  EXCEL
  PDF
  JSON
}

enum AIProvider {
  OPENAI
  ANTHROPIC
  GOOGLE
  AZURE_OPENAI
  COHERE
  HUGGINGFACE
  CUSTOM
}

enum IdentityProvider {
  LOCAL
  GOOGLE
  MICROSOFT
  GITHUB
  GITLAB
  OKTA
  AUTH0
  SAML
  OIDC
  CUSTOM
}

enum SurveyVisibility {
  PUBLIC
  PRIVATE
  PASSWORD_PROTECTED
  UNLISTED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?   // Nullable for SSO users
  firstName     String?
  lastName      String?
  avatar        String?
  role          UserRole  @default(VIEWER)
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  provider      IdentityProvider @default(LOCAL)
  providerId    String?   // ID from SSO provider
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  surveys           Survey[]
  workspaces        WorkspaceMember[]
  apiKeys           ApiKey[]
  sessions          Session[]
  activityLogs      ActivityLog[]
  createdTemplates  SurveyTemplate[]
  aiProviders       UserAIProvider[]
  mlModels          MLModel[]

  @@index([email])
  @@index([provider, providerId])
}

model UserAIProvider {
  id          String     @id @default(cuid())
  userId      String
  provider    AIProvider
  apiKey      String     // Encrypted
  modelName   String?    // e.g., "gpt-4", "claude-3-opus", "gemini-pro"
  endpoint    String?    // For custom providers
  isDefault   Boolean    @default(false)
  isActive    Boolean    @default(true)
  settings    Json?      // Provider-specific settings
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@index([isDefault])
}

// License Management
enum LicenseTier {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum LicenseStatus {
  ACTIVE
  EXPIRED
  REVOKED
  SUSPENDED
}

model License {
  id                String        @id @default(cuid())
  licenseKey        String        @unique // Full encrypted license key
  customerId        String        // Customer identifier from license payload
  email             String
  companyName       String
  tier              LicenseTier
  status            LicenseStatus @default(ACTIVE)

  // License validity
  issuedAt          DateTime
  expiresAt         DateTime
  activatedAt       DateTime?     // When customer first activated the license
  lastVerifiedAt    DateTime      @default(now()) // Last successful verification

  // Limits (from license payload)
  maxUsers          Int           @default(-1) // -1 means unlimited
  maxSurveys        Int           @default(-1)
  maxResponses      Int           @default(-1)

  // Features (JSON array of feature flags)
  features          Json          // ["sso", "white_label", "api_access", etc.]

  // Instance binding (optional - ties license to specific installation)
  instanceId        String?       @unique
  instanceFingerprint String?     // Machine/server fingerprint

  // Usage tracking
  currentUsers      Int           @default(0)
  currentSurveys    Int           @default(0)
  currentResponses  Int           @default(0) // Monthly counter, resets each month
  lastUsageUpdate   DateTime      @default(now())

  // Grace period for offline operation
  gracePeriodDays   Int           @default(30)
  offlineSince      DateTime?     // When license verification last failed

  // Metadata
  notes             String?       // Internal notes
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  verificationLogs  LicenseVerificationLog[]

  @@index([licenseKey])
  @@index([email])
  @@index([customerId])
  @@index([status])
  @@index([expiresAt])
}

// License verification audit log
model LicenseVerificationLog {
  id            String    @id @default(cuid())
  licenseId     String
  success       Boolean
  errorMessage  String?
  verifiedAt    DateTime  @default(now())
  ipAddress     String?
  userAgent     String?

  license License @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@index([licenseId])
  @@index([verifiedAt])
}

// Platform configuration (for license enforcement, analytics, etc.)
model PlatformConfig {
  id                      String   @id @default(cuid())

  // License enforcement
  licenseEnforced         Boolean  @default(false)  // Toggle license requirement
  licenseGracePeriod      Boolean  @default(true)   // Allow grace period

  // Analytics
  analyticsEnabled        Boolean  @default(false)
  googleAnalyticsId       String?  // GA4 Measurement ID (e.g., G-XXXXXXXXXX)

  // Telemetry
  telemetryEnabled        Boolean  @default(false)  // Anonymous usage stats

  // Instance info
  instanceName            String?
  instanceDescription     String?
  adminEmail              String?

  // Metadata
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@map("platform_config")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
}

model ApiKey {
  id        String   @id @default(cuid())
  userId    String
  name      String
  key       String   @unique
  isActive  Boolean  @default(true)
  lastUsed  DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([key])
}

model Workspace {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members WorkspaceMember[]
  surveys Survey[]

  @@index([name])
}

model WorkspaceMember {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  role        UserRole @default(VIEWER)
  joinedAt    DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

model Survey {
  id            String           @id @default(cuid())
  title         String
  description   String?
  status        SurveyStatus     @default(DRAFT)
  visibility    SurveyVisibility @default(PUBLIC)
  password      String?          // For password-protected surveys
  workspaceId   String?
  createdBy     String
  isAnonymous   Boolean          @default(false)
  allowMultiple Boolean          @default(false)
  responseLimit Int?
  closeDate     DateTime?
  welcomeText   String?
  thankYouText  String?
  slug          String           @unique
  shareableLink String?          // Custom shareable link
  embedCode     String?          // Embed code for websites
  qrCode        String?          // QR code URL
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  publishedAt   DateTime?

  // Relations
  creator       User             @relation(fields: [createdBy], references: [id])
  workspace     Workspace?       @relation(fields: [workspaceId], references: [id])
  pages         SurveyPage[]
  questions     Question[]
  responses     Response[]
  theme         SurveyTheme?
  analytics     SurveyAnalytics?
  aiInsights    AiInsight[]
  distributions Distribution[]
  exports       Export[]
  mlModels      MLModel[]
  predictions   Prediction[]

  @@index([createdBy])
  @@index([workspaceId])
  @@index([status])
  @@index([slug])
  @@index([visibility])
}

model SurveyPage {
  id          String  @id @default(cuid())
  surveyId    String
  title       String?
  description String?
  order       Int

  survey    Survey     @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  questions Question[]

  @@index([surveyId])
  @@index([order])
}

model Question {
  id           String       @id @default(cuid())
  surveyId     String
  pageId       String?
  type         QuestionType
  text         String
  description  String?
  order        Int
  isRequired   Boolean      @default(false)
  isRandomized Boolean      @default(false)

  // Question-specific settings (stored as JSON)
  settings     Json?        // Flexible field for type-specific settings
  validation   Json?        // Validation rules

  survey  Survey       @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  page    SurveyPage?  @relation(fields: [pageId], references: [id])
  options QuestionOption[]
  answers Answer[]
  logic   SurveyLogic[]    @relation("SourceQuestion")
  targets SurveyLogic[]    @relation("TargetQuestion")

  @@index([surveyId])
  @@index([pageId])
  @@index([order])
}

model QuestionOption {
  id         String  @id @default(cuid())
  questionId String
  text       String
  value      String
  order      Int
  imageUrl   String?

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answers  Answer[]

  @@index([questionId])
  @@index([order])
}

model SurveyLogic {
  id              String    @id @default(cuid())
  surveyId        String
  sourceQuestionId String
  targetQuestionId String?
  type            LogicType
  conditions      Json      // Array of conditions
  actions         Json      // Actions to perform

  survey         Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  sourceQuestion Question @relation("SourceQuestion", fields: [sourceQuestionId], references: [id], onDelete: Cascade)
  targetQuestion Question? @relation("TargetQuestion", fields: [targetQuestionId], references: [id])

  @@index([surveyId])
  @@index([sourceQuestionId])
}

model SurveyTheme {
  id               String  @id @default(cuid())
  surveyId         String  @unique
  primaryColor     String  @default("#3B82F6")
  secondaryColor   String  @default("#6B7280")
  backgroundColor  String  @default("#FFFFFF")
  textColor        String  @default("#1F2937")
  fontFamily       String  @default("Inter")
  logoUrl          String?
  customCss        String?

  survey Survey @relation(fields: [surveyId], references: [id], onDelete: Cascade)
}

model Response {
  id          String   @id @default(cuid())
  surveyId    String
  ipAddress   String?
  userAgent   String?
  location    Json?    // Geo location data
  startedAt   DateTime @default(now())
  completedAt DateTime?
  duration    Int?     // Duration in seconds
  isComplete  Boolean  @default(false)
  metadata    Json?    // Additional metadata

  survey      Survey       @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  answers     Answer[]
  predictions Prediction[]

  @@index([surveyId])
  @@index([completedAt])
  @@index([isComplete])
}

model Answer {
  id         String   @id @default(cuid())
  responseId String
  questionId String
  optionId   String?
  textValue  String?
  numberValue Float?
  dateValue  DateTime?
  fileUrl    String?
  metadata   Json?    // For complex answer types
  createdAt  DateTime @default(now())

  response Response        @relation(fields: [responseId], references: [id], onDelete: Cascade)
  question Question        @relation(fields: [questionId], references: [id])
  option   QuestionOption? @relation(fields: [optionId], references: [id])

  @@index([responseId])
  @@index([questionId])
}

model SurveyAnalytics {
  id                String   @id @default(cuid())
  surveyId          String   @unique
  totalResponses    Int      @default(0)
  completeResponses Int      @default(0)
  averageDuration   Float?
  completionRate    Float?
  dropoffRate       Float?
  analyticsData     Json?    // Cached analytics
  lastCalculated    DateTime @default(now())

  survey Survey @relation(fields: [surveyId], references: [id], onDelete: Cascade)
}

model AiInsight {
  id          String   @id @default(cuid())
  surveyId    String
  provider    String   // AI provider used
  model       String?  // Model name
  type        String   // 'summary', 'sentiment', 'themes', 'recommendations'
  insight     String
  confidence  Float?
  metadata    Json?
  createdAt   DateTime @default(now())

  survey Survey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId])
  @@index([type])
}

model Distribution {
  id           String   @id @default(cuid())
  surveyId     String
  type         String   // 'email', 'link', 'embed', 'qr'
  recipientEmail String?
  sentAt       DateTime?
  openedAt     DateTime?
  respondedAt  DateTime?
  metadata     Json?
  createdAt    DateTime @default(now())

  survey Survey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId])
  @@index([recipientEmail])
}

model Export {
  id          String       @id @default(cuid())
  surveyId    String
  format      ExportFormat
  fileUrl     String?
  status      String       @default("pending") // 'pending', 'processing', 'completed', 'failed'
  errorMessage String?
  createdAt   DateTime     @default(now())
  completedAt DateTime?

  survey Survey @relation(fields: [surveyId], references: [id], onDelete: Cascade)

  @@index([surveyId])
  @@index([status])
}

model SurveyTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String
  imageUrl    String?
  content     Json     // Full survey structure
  isPublic    Boolean  @default(true)
  usageCount  Int      @default(0)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator User? @relation(fields: [createdBy], references: [id])

  @@index([category])
  @@index([isPublic])
}

model QuestionBank {
  id          String       @id @default(cuid())
  category    String
  type        QuestionType
  text        String
  description String?
  options     Json?        // For choice questions
  usageCount  Int          @default(0)
  createdAt   DateTime     @default(now())

  @@index([category])
  @@index([type])
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  resource  String
  resourceId String?
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model IdentityProviderConfig {
  id          String           @id @default(cuid())
  provider    IdentityProvider
  name        String           // Display name
  clientId    String
  clientSecret String          // Encrypted
  issuer      String?          // For OIDC/SAML
  authUrl     String?
  tokenUrl    String?
  userInfoUrl String?
  callbackUrl String?
  scopes      String[]         // OAuth scopes
  isEnabled   Boolean          @default(false)
  isDefault   Boolean          @default(false)
  metadata    Json?            // Provider-specific config
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([provider])
  @@index([isEnabled])
}

model SMTPConfig {
  id        String   @id @default(cuid())
  host      String
  port      Int
  secure    Boolean  @default(false)
  username  String
  password  String   // Encrypted
  fromEmail String
  fromName  String?
  replyTo   String?
  isActive  Boolean  @default(true)
  isDefault Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model PlatformBranding {
  id              String   @id @default(cuid())
  platformName    String   @default("PulseGen")
  logoUrl         String?  // Main logo
  faviconUrl      String?  // Favicon
  loginBgUrl      String?  // Login page background
  primaryColor    String   @default("#3B82F6")
  secondaryColor  String   @default("#6B7280")
  accentColor     String   @default("#10B981")
  customCss       String?  @db.Text
  customJs        String?  @db.Text
  footerText      String?
  supportEmail    String?
  termsUrl        String?
  privacyUrl      String?
  showPoweredBy   Boolean  @default(true) // "Powered by PulseGen"
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum AIToolType {
  MINDSDB
  TENSORFLOW
  PYTORCH
  HUGGINGFACE
  CUSTOM
}

enum ModelStatus {
  TRAINING
  READY
  FAILED
  ARCHIVED
}

enum AccessRequestStatus {
  PENDING
  APPROVED
  REJECTED
  INVITED
}

// Download Access Request (for pre-monetization audience building)
model DownloadAccessRequest {
  id                    String              @id @default(cuid())
  email                 String
  githubUsername        String              // To invite to private repo
  fullName              String?

  // Social media verification
  youtubeSubscribed     Boolean             @default(false)
  instagramFollowed     Boolean             @default(false)
  proofScreenshotUrl    String?             // Optional: Screenshot proof

  // Status
  status                AccessRequestStatus @default(PENDING)
  statusNote            String?             // Admin notes

  // GitHub invitation
  githubInviteSent      Boolean             @default(false)
  githubInvitedAt       DateTime?
  githubInviteAccepted  Boolean             @default(false)

  // Metadata
  ipAddress             String?
  userAgent             String?
  referralSource        String?             // Where they found PulseGen

  // Timestamps
  createdAt             DateTime            @default(now())
  reviewedAt            DateTime?
  reviewedBy            String?             // Admin user ID who reviewed

  @@index([email])
  @@index([githubUsername])
  @@index([status])
  @@index([createdAt])
}

model AIToolConfig {
  id          String      @id @default(cuid())
  type        AIToolType
  name        String      // Display name
  endpoint    String      // API endpoint or connection string
  apiKey      String?     // Encrypted API key
  username    String?     // For DB-style connections
  password    String?     // Encrypted password
  database    String?     // Database name (for MindsDB)
  settings    Json?       // Tool-specific configuration
  isEnabled   Boolean     @default(false)
  isDefault   Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  models      MLModel[]

  @@unique([type, name])
  @@index([isEnabled])
  @@index([type])
}

model MLModel {
  id            String      @id @default(cuid())
  toolConfigId  String
  name          String
  displayName   String?
  description   String?     @db.Text
  modelType     String      // regression, classification, time_series, nlp, etc.
  targetColumn  String?     // What the model predicts
  features      String[]    // Input features/columns
  status        ModelStatus @default(TRAINING)
  accuracy      Float?      // Model accuracy/score
  metadata      Json?       // Training params, metrics, etc.
  query         String?     @db.Text // SQL query or config used to create
  surveyId      String?     // Associated survey if applicable
  createdBy     String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  lastUsedAt    DateTime?

  toolConfig    AIToolConfig @relation(fields: [toolConfigId], references: [id], onDelete: Cascade)
  creator       User         @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  survey        Survey?      @relation(fields: [surveyId], references: [id], onDelete: SetNull)
  predictions   Prediction[]

  @@index([toolConfigId])
  @@index([status])
  @@index([surveyId])
  @@index([createdBy])
}

model Prediction {
  id          String   @id @default(cuid())
  modelId     String
  surveyId    String?
  responseId  String?
  input       Json     // Input data used for prediction
  output      Json     // Prediction result
  confidence  Float?   // Confidence score
  metadata    Json?    // Additional prediction metadata
  createdAt   DateTime @default(now())

  model       MLModel   @relation(fields: [modelId], references: [id], onDelete: Cascade)
  survey      Survey?   @relation(fields: [surveyId], references: [id], onDelete: SetNull)
  response    Response? @relation(fields: [responseId], references: [id], onDelete: SetNull)

  @@index([modelId])
  @@index([surveyId])
  @@index([responseId])
  @@index([createdAt])
}
